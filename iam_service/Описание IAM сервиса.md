# Описание IAM сервиса

## Назначение

Этот сервис управляет идентификацией пользователей (регистрация, аутентификация) и предоставляет доступ к ресурсам на основе прав доступа (авторизация). Сервис поддерживает стандарты **OIDC (OpenID Connect)** и выдает **ID Token**, **Access Token**, и **Refresh Token** в формате **JWT** или **JWE**. **IAM сервис** позволяет безопасно управлять токенами, а также включает ротацию ключей для обеспечения безопасности.

## Основные сущности

- **User (Пользователь)**: Учётная запись пользователя, содержащая данные, такие как email и пароль (хешированный).
- **Access Token (Токен доступа)**: Токен, который выдается пользователю после успешного входа в систему. Этот токен содержит информацию о правах доступа.
- **Refresh Token (Токен обновления)**: Токен, который позволяет получить новый Access Token без повторной аутентификации.
- **ID Token (ID-токен)**: **JWT-токен**, который содержит информацию о пользователе и подтверждает его аутентификацию.
- **Public Key (Публичный ключ)**: Ключ, который используется для валидации токенов и предоставляется другим сервисам для проверки подписей.

## Основные функции

1. **Регистрация пользователя**: Пользователь может зарегистрировать новую учетную запись.
2. **Подтверждение регистрации**: Пользователь подтверждает свою учетную запись с помощью кода, отправленного по email.
3. **Логин, выдача токенов по стандарту OIDC**: Пользователь может войти в систему, получить **ID Token**, **Access Token** и **Refresh Token** в соответствии с OIDC. Токены могут быть переданы в куки или в теле ответа в зависимости от типа клиента.
4. **Обновление токенов по стандарту OIDC**: Пользователь может обновить **Access Token** с помощью **Refresh Token** в соответствии с OIDC. **ID Token** не обновляется через Refresh Token и может быть получен только через повторную аутентификацию.
5. **Логаут, удаление токенов**: Пользователь может выйти из системы, а токены будут аннулированы.
6. **Публикация ключей**: Сервис предоставляет публичные ключи для валидации токенов.

## Основные юзкейсы

1. **Регистрация пользователя**: Пользователь создает новую учетную запись с email и паролем. 
   - После успешной регистрации пользователю отправляется код подтверждения на email.
   
2. **Подтверждение учетной записи**: Пользователь подтверждает свою учетную запись через код, отправленный по email.
   - После подтверждения учетной записи пользователь может войти в систему.

3. **Аутентификация пользователя**: Пользователь вводит свой email и пароль для входа в систему. Система выдает **ID Token**, **Access Token** и, опционально, **Refresh Token**. Токены могут быть переданы в **куки** или в **теле ответа**.
   - **Access Token** используется для авторизации при запросах к защищённым ресурсам.
   - **ID Token** содержит информацию об аутентификации и может быть использован для отображения данных пользователя на клиентской стороне.

4. **Обновление Access Token**: Если **Access Token** истекает, пользователь может использовать **Refresh Token** для получения нового **Access Token**. 
   - **Refresh Token** должен быть защищен, и его нельзя передавать в открытом виде на клиенте.

5. **Логаут пользователя**: Пользователь выходит из системы, и **Access Token**, **Refresh Token** аннулируются. Это завершает сессию пользователя и предотвращает дальнейший доступ с использованием старых токенов.

6. **Публикация публичных ключей**: Другие сервисы могут запросить публичные ключи для проверки подписи токенов, выданных этим IAM сервисом.

## API

1. **Регистрация пользователя**:
   - **URL**: `POST /users`
   - **Описание**: Создание нового пользователя.
   - **Контроллер**: `user_controller`

2. **Подтверждение пользователя**:
   - **URL**: `POST /users/confirm`
   - **Описание**: Подтверждение учетной записи пользователя по email.
   - **Контроллер**: `confirm_controller`

3. **Логин (OIDC авторизация)**:
   - **URL**: `POST /authorize`
   - **Описание**: Начало OIDC-потока авторизации, передача пользователя на страницу входа.
   - **Контроллер**: `oidc_authorization_controller`

4. **Получение токенов (OIDC токен)**:
   - **URL**: `POST /token`
   - **Описание**: Выдача **ID Token**, **Access Token** и **Refresh Token** после успешной аутентификации через OIDC.
   - **Контроллер**: `oidc_token_controller`

5. **Обновление токенов (OIDC обновление токенов)**:
   - **URL**: `POST /token`
   - **Описание**: Обновление **Access Token** и **Refresh Token** с использованием **Refresh Token** в соответствии с OIDC стандартом. **ID Token** не обновляется.
   - **Контроллер**: `oidc_token_controller`

6. **Логаут**:
   - **URL**: `POST /logout`
   - **Описание**: Завершение сессии пользователя, аннулирование токенов.
   - **Контроллер**: `oidc_logout_controller`

7. **Получение публичных ключей**:
   - **URL**: `GET /public-keys`
   - **Описание**: Получение публичных ключей для валидации JWT токенов другими сервисами.
   - **Контроллер**: `public_keys_controller`

## UI

1. **Регистрация**:
   - **URL**: `GET /users/signup`
   - **Описание**: Пользователю предоставляется форма для регистрации.
   - **Контроллер**: `signup_controller`
   - **Вызывает**: `POST /users`
   - **Успех**: Редирект на `/users/confirm`
   - **Ошибка**: Отображение ошибок валидации или других ошибок на форме регистрации.

2. **Подтверждение пользователя**:
   - **URL**: `GET /users/confirm`
   - **Описание**: Пользователю предоставляется форма для ввода кода подтверждения.
   - **Контроллер**: `confirm_controller`
   - **Вызывает**: `POST /users/confirm`
   - **Успех**: Редирект на `/login`
   - **Ошибка**: Отображение ошибок валидации или других ошибок на форме подтверждения.

3. **Логин**:
   - **URL**: `GET /users/signin`
   - **Описание**: Пользователю предоставляется форма для входа в систему.
   - **Контроллер**: `signin_controller`
   - **Вызывает**: `POST /authorize`
   - **Успех**: Редирект на `/`
   - **Ошибка**: Отображение ошибок валидации или других ошибок на форме входа.

4. **Данные пользователя**:
   - **URL**: `GET /users`
   - **Описание**: Пользователю отображаются его данные (email и другая профильная информация).
   - **Контроллер**: `user_controller`
   - **Успех**: Отображение данных пользователя.
   - **Ошибка**: Отображение ошибок.

## Стек технологий

- **Back-end**: REST API на основе **Axum**, **sqlx** для работы с базой данных **PostgreSQL**.
- **Front-end**: **HTMX** для асинхронного взаимодействия с сервером без перезагрузки страниц.

## Хранение токенов

### Рекомендации по хранению токенов

1. **Access Token** и **ID Token** могут передаваться в **Cookies** для веб-приложений. Использование флагов **HttpOnly**, **Secure** и **SameSite** обеспечит максимальную защиту от XSS и CSRF атак:
   ```http
   Set-Cookie: access_token=<token>; HttpOnly; Secure; SameSite=Strict
   Set-Cookie: id_token=<token>; HttpOnly; Secure; SameSite=Strict
